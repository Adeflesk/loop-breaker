<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoopBreaker - Architecture Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        nav {
            background: #f8f9fa;
            padding: 20px 40px;
            border-bottom: 2px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        nav a {
            color: #667eea;
            text-decoration: none;
            margin-right: 25px;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        nav a:hover {
            color: #764ba2;
        }
        
        .content {
            padding: 40px;
        }
        
        section {
            margin-bottom: 60px;
        }
        
        h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        h3 {
            color: #764ba2;
            font-size: 1.5em;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        h4 {
            color: #555;
            font-size: 1.2em;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        p, li {
            margin-bottom: 10px;
            color: #555;
        }
        
        .module {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .module h4 {
            color: #667eea;
            margin-top: 0;
        }
        
        .flow-diagram {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .flow-step {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .flow-arrow {
            display: inline-block;
            color: #667eea;
            font-size: 2em;
            margin: 0 10px;
        }
        
        .endpoint {
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .endpoint-method {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            margin-right: 10px;
        }
        
        .get { background: #28a745; color: white; }
        .post { background: #007bff; color: white; }
        .delete { background: #dc3545; color: white; }
        
        .endpoint-path {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-weight: bold;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
        }
        
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .tech-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .tech-card h4 {
            color: white;
            margin-bottom: 10px;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #764ba2;
        }
        
        .feature-card h4 {
            color: #764ba2;
            margin-top: 0;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÑ LoopBreaker</h1>
            <p>Architecture & System Documentation</p>
        </header>
        
        <nav>
            <a href="#overview">Overview</a>
            <a href="#tech-stack">Tech Stack</a>
            <a href="#modules">Modules</a>
            <a href="#data-flow">Data Flow</a>
            <a href="#api">API Endpoints</a>
            <a href="#features">Features</a>
        </nav>
        
        <div class="content">
            <!-- OVERVIEW -->
            <section id="overview">
                <h2>üìã System Overview</h2>
                <p>LoopBreaker is a mental health intervention app that helps users identify and break repetitive negative emotional patterns (loops) using evidence-based techniques from behavioral science and neuroscience.</p>
                
                <h3>Core Concept: The Rewire Model</h3>
                <p>The app implements Dr. Nicole LePera's "Rewire" framework:</p>
                <ol>
                    <li><strong>Acute Stress Detection</strong> - Single emotional event captured via journal entry</li>
                    <li><strong>Chronic Pattern Recognition</strong> - 3 consecutive similar states = detected loop</li>
                    <li><strong>Physiological Assessment (HALT)</strong> - Check for unmet needs: Hydration, Fuel (hunger), Rest, Movement</li>
                    <li><strong>Movement Protocol Intervention</strong> - Zone-specific exercises mapped to emotional states</li>
                    <li><strong>Parasympathetic Recovery</strong> - Track trend (improving/stable) and streak (consecutive successful interventions)</li>
                </ol>
                
                <div class="info-box">
                    <strong>Key Insight:</strong> The app uses a graph database (Neo4j) to track temporal relationships between emotional states, interventions, and outcomes - enabling pattern detection that traditional relational databases can't efficiently provide.
                </div>
            </section>
            
            <!-- TECH STACK -->
            <section id="tech-stack">
                <h2>üõ†Ô∏è Technology Stack</h2>
                <div class="tech-stack">
                    <div class="tech-card">
                        <h4>Backend</h4>
                        <p><strong>FastAPI</strong> (Python 3.14)</p>
                        <p>Async API server with Pydantic validation</p>
                    </div>
                    <div class="tech-card">
                        <h4>Database</h4>
                        <p><strong>Neo4j</strong></p>
                        <p>Graph database for relational pattern analysis</p>
                    </div>
                    <div class="tech-card">
                        <h4>AI Engine</h4>
                        <p><strong>Ollama</strong> (llama3.2:1b)</p>
                        <p>Local LLM for emotion classification</p>
                    </div>
                    <div class="tech-card">
                        <h4>Frontend</h4>
                        <p><strong>Flutter</strong> (Dart)</p>
                        <p>Cross-platform mobile/web UI</p>
                    </div>
                </div>
            </section>
            
            <!-- MODULES -->
            <section id="modules">
                <h2>üì¶ Module Responsibilities</h2>
                
                <div class="module">
                    <h4>backend/app/main.py - API Orchestration Layer</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>FastAPI application setup & CORS middleware</li>
                        <li>Dependency injection (DB manager via lifespan events)</li>
                        <li>Feature flag management (sublabels, HALT, trends, movement protocols)</li>
                        <li>Request/response routing to appropriate handlers</li>
                    </ul>
                    <p><strong>Key Dependencies:</strong> <code>ai.py</code>, <code>db.py</code>, <code>interventions.py</code>, <code>models.py</code></p>
                </div>
                
                <div class="module">
                    <h4>backend/app/ai.py - Emotion Classification Engine</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>Query Ollama LLM with structured prompt</li>
                        <li>Parse AI response into validated emotion + sublabel</li>
                        <li>Map free-text journal entries to 7 emotional states:
                            <ul>
                                <li><strong>Stress</strong> - Overwhelmed, Anxious, Burnt-out</li>
                                <li><strong>Procrastination</strong> - Avoidance, Perfectionism, Fear of Failure</li>
                                <li><strong>Anxiety</strong> - Worry, Panic, Dread</li>
                                <li><strong>Shame</strong> - Guilt, Embarrassment, Self-blame</li>
                                <li><strong>Overwhelm</strong> - Paralysis, Cognitive Overload, Scattered</li>
                                <li><strong>Numbness</strong> - Disconnected, Apathy, Exhaustion</li>
                                <li><strong>Isolation</strong> - Loneliness, Withdrawal, Avoidance of Others</li>
                            </ul>
                        </li>
                        <li>Fallback handling when Ollama unavailable (default to "Stress")</li>
                    </ul>
                    <p><strong>Key Functions:</strong></p>
                    <ul>
                        <li><code>query_local_ai(text)</code> - Async HTTP call to Ollama</li>
                        <li><code>clean_ai_response(json)</code> - Validation & normalization</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>backend/app/db.py - Graph Database Manager</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>Neo4j driver lifecycle management (connect, close, retry)</li>
                        <li>Graph schema bootstrap (create Node labels for each emotion)</li>
                        <li>Entry persistence with temporal relationships</li>
                        <li>Chronic loop detection (sliding 3-entry window)</li>
                        <li>Intervention tracking & outcome recording</li>
                        <li>Pattern analysis (top loops, success rates, HALT triggers)</li>
                        <li>Graceful degradation when Neo4j unavailable</li>
                    </ul>
                    <p><strong>Key Methods:</strong></p>
                    <ul>
                        <li><code>log_and_analyze()</code> - Creates Entry‚ÜíNode relationship, checks for loops</li>
                        <li><code>resolve_intervention()</code> - Records Outcome node with HALT data</li>
                        <li><code>get_ai_insight()</code> - Queries graph for patterns & coaching messages</li>
                        <li><code>get_history()</code> - Fetches last 20 entries with interventions</li>
                        <li><code>get_trend_stats()</code> - Counts entries per emotional state</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>backend/app/interventions.py - Protocol Mapping</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>Maps emotional states to evidence-based interventions</li>
                        <li>Provides educational context (why the intervention works)</li>
                        <li>Tags interventions by type: breathing, grounding, cognitive, movement, other</li>
                    </ul>
                    <p><strong>Example Mapping:</strong></p>
                    <ul>
                        <li>Stress ‚Üí Physiological Sigh (breathing)</li>
                        <li>Anxiety ‚Üí 5-4-3-2-1 Grounding (grounding)</li>
                        <li>Procrastination ‚Üí 5-Minute Sprint (cognitive)</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>backend/app/models.py - Data Contracts</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>Pydantic models for request/response validation</li>
                        <li>Type safety across API boundaries</li>
                        <li>Auto-generated OpenAPI documentation</li>
                    </ul>
                    <p><strong>Key Models:</strong></p>
                    <ul>
                        <li><code>JournalRequest</code> - User journal entry input</li>
                        <li><code>AnalysisResponse</code> - Emotion analysis + intervention</li>
                        <li><code>FeedbackRequest</code> - Intervention outcome + HALT data</li>
                        <li><code>InsightResponse</code> - Pattern insights & trends</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>frontend/lib/main.dart - Flutter App Entry Point</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>MaterialApp configuration & theming</li>
                        <li>Route management</li>
                        <li>Backend API endpoint configuration</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>frontend/lib/services/ - API Client Layer</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li>HTTP communication with backend</li>
                        <li>Request/response serialization</li>
                        <li>Error handling & retry logic</li>
                    </ul>
                </div>
                
                <div class="module">
                    <h4>frontend/lib/screens/ - UI Components</h4>
                    <p><strong>Responsibilities:</strong></p>
                    <ul>
                        <li><strong>journal_screen.dart</strong> - Main entry point for journal input & intervention display</li>
                        <li><strong>history_screen.dart</strong> - Timeline view of past entries</li>
                        <li>State management with StatefulWidgets</li>
                        <li>Conditional rendering based on feature flags</li>
                    </ul>
                </div>
            </section>
            
            <!-- DATA FLOW -->
            <section id="data-flow">
                <h2>üîÑ Data Flow Architecture</h2>
                
                <h3>1. Journal Entry ‚Üí Emotion Analysis</h3>
                <div class="flow-diagram">
                    <div class="flow-step">User writes journal entry</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Flutter POST /analyze</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">FastAPI receives text</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">ai.py queries Ollama</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">LLM returns emotion + sublabel</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">db.py stores Entry node</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Loop detection (3-entry check)</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">interventions.py maps protocol</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Response with intervention</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Flutter displays card</div>
                </div>
                
                <h3>2. Intervention Feedback Loop</h3>
                <div class="flow-diagram">
                    <div class="flow-step">User completes intervention</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">HALT check-in (4 toggles)</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Flutter POST /feedback</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">db.py creates Outcome node</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Links Intervention‚ÜíOutcome</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Resets loop counter if successful</div>
                </div>
                
                <h3>3. Insight Generation</h3>
                <div class="flow-diagram">
                    <div class="flow-step">Flutter GET /insight</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">db.py queries graph</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Aggregates patterns</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Calculates success rate</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Identifies unmet HALT needs</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Generates coaching message</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-step">Flutter displays insight card</div>
                </div>
                
                <h3>Neo4j Graph Structure</h3>
                <div class="info-box">
                    <strong>Node Types:</strong>
                    <ul>
                        <li><strong>Node</strong> - Emotional states (Stress, Anxiety, etc.)</li>
                        <li><strong>Entry</strong> - Journal entry with timestamp, confidence, emotion_sublabel</li>
                        <li><strong>Intervention</strong> - Protocol with title, task, timestamp</li>
                        <li><strong>Outcome</strong> - Success + HALT data (hydration, fuel, rest, movement)</li>
                    </ul>
                    <strong>Relationships:</strong>
                    <ul>
                        <li><code>Entry-[:RECORDS_STATE]‚ÜíNode</code></li>
                        <li><code>Entry-[:HAS_INTERVENTION]‚ÜíIntervention</code></li>
                        <li><code>Intervention-[:HAS_OUTCOME]‚ÜíOutcome</code></li>
                    </ul>
                </div>
            </section>
            
            <!-- API ENDPOINTS -->
            <section id="api">
                <h2>üåê API Endpoints</h2>
                
                <div class="endpoint">
                    <span class="endpoint-method post">POST</span>
                    <span class="endpoint-path">/analyze</span>
                    <p><strong>Purpose:</strong> Analyze journal entry and return intervention</p>
                    <p><strong>Request Body:</strong></p>
                    <code>{ "user_text": "I feel overwhelmed with everything..." }</code>
                    <p><strong>Response Fields:</strong></p>
                    <ul>
                        <li><code>detected_node</code> - Primary emotional state</li>
                        <li><code>emotion_sublabel</code> - Specific emotion from wheel (if FEATURE_SUBLABELS=true)</li>
                        <li><code>confidence</code> - AI confidence score (0.0-1.0)</li>
                        <li><code>reasoning</code> - Brief explanation</li>
                        <li><code>loop_detected</code> - Boolean (3 consecutive entries?)</li>
                        <li><code>risk_level</code> - "High" or "Low"</li>
                        <li><code>intervention_title</code> - Protocol name</li>
                        <li><code>intervention_task</code> - Step-by-step instructions</li>
                        <li><code>education_info</code> - Why it works (neuroscience)</li>
                        <li><code>intervention_type</code> - Protocol category (if FEATURE_MOVEMENT_PROTOCOLS=true)</li>
                    </ul>
                </div>
                
                <div class="endpoint">
                    <span class="endpoint-method post">POST</span>
                    <span class="endpoint-path">/feedback</span>
                    <p><strong>Purpose:</strong> Record intervention outcome & HALT data</p>
                    <p><strong>Request Body:</strong></p>
                    <code>{ "success": true, "needs_check": { "hydration": true, "fuel": false, "rest": true, "movement": false } }</code>
                    <p><strong>Response:</strong> <code>{ "status": "recorded" }</code></p>
                </div>
                
                <div class="endpoint">
                    <span class="endpoint-method get">GET</span>
                    <span class="endpoint-path">/insight</span>
                    <p><strong>Purpose:</strong> Get pattern analysis & coaching message</p>
                    <p><strong>Response Fields:</strong></p>
                    <ul>
                        <li><code>message</code> - Coaching insight</li>
                        <li><code>success_rate</code> - Percentage of successful interventions</li>
                        <li><code>top_loop</code> - Most frequent emotional state</li>
                        <li><code>missing_need</code> - Most common unmet HALT need</li>
                        <li><code>trigger_count</code> - How many times unmet need preceded loop</li>
                        <li><code>trend</code> - "improving" or "stable" (if FEATURE_RECOVERY_TREND=true)</li>
                        <li><code>streak</code> - Consecutive successful interventions (if FEATURE_RECOVERY_TREND=true)</li>
                    </ul>
                </div>
                
                <div class="endpoint">
                    <span class="endpoint-method get">GET</span>
                    <span class="endpoint-path">/history</span>
                    <p><strong>Purpose:</strong> Fetch last 20 journal entries</p>
                    <p><strong>Response:</strong> Array of entries with timestamps, states, interventions, outcomes</p>
                </div>
                
                <div class="endpoint">
                    <span class="endpoint-method delete">DELETE</span>
                    <span class="endpoint-path">/reset</span>
                    <p><strong>Purpose:</strong> Wipe all user data (requires confirmation header)</p>
                    <p><strong>Security:</strong> Must send <code>X-Confirm-Reset: yes</code> header</p>
                </div>
            </section>
            
            <!-- FEATURES -->
            <section id="features">
                <h2>‚ú® Key Features (Rewire Implementation)</h2>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <h4>LB-102: Emotion Wheel Sublabels</h4>
                        <p>Granular emotion classification beyond 7 primary states</p>
                        <p><strong>Status:</strong> ‚úÖ Complete</p>
                        <ul>
                            <li>AI prompt includes sublabel schema</li>
                            <li>Persisted in Entry.emotion_sublabel</li>
                            <li>Returned in /analyze response</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h4>LB-402: Movement Protocol Types</h4>
                        <p>Categorize interventions for future zone mapping</p>
                        <p><strong>Status:</strong> ‚úÖ Complete</p>
                        <ul>
                            <li>All 7 interventions tagged with type</li>
                            <li>Returned in /analyze response</li>
                            <li>Foundation for Zone 1-3 exercises</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h4>LB-301: Recovery Trend Indicators</h4>
                        <p>Visual feedback on parasympathetic recovery</p>
                        <p><strong>Status:</strong> ‚úÖ Complete</p>
                        <ul>
                            <li>Trend: improving (‚â•70% success) or stable</li>
                            <li>Streak: consecutive successful interventions</li>
                            <li>Icons: üî• trending_up, trending_down</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h4>LB-501: Feature Flags</h4>
                        <p>Safe rollout of new functionality</p>
                        <p><strong>Status:</strong> ‚úÖ Complete</p>
                        <ul>
                            <li>FEATURE_SUBLABELS</li>
                            <li>FEATURE_NEEDS_CHECK</li>
                            <li>FEATURE_RECOVERY_TREND</li>
                            <li>FEATURE_MOVEMENT_PROTOCOLS</li>
                        </ul>
                    </div>
                </div>
                
                <h3>Loop Detection Algorithm</h3>
                <div class="info-box">
                    <p><strong>Logic:</strong></p>
                    <ol>
                        <li>Query last 3 Entry nodes ordered by timestamp DESC</li>
                        <li>Extract the Node.name each Entry records</li>
                        <li>Check if all 3 names are identical</li>
                        <li>If true: <code>loop_detected = True</code>, <code>risk_level = "High"</code></li>
                        <li>Create Intervention node linked to most recent Entry</li>
                        <li>When feedback submitted with <code>success = True</code>, reset counter (clear recent history)</li>
                    </ol>
                    <p><strong>Edge Case:</strong> Sublabels "Overwhelmed", "Burnout", "Burnt-out" immediately trigger <code>risk_level = "High"</code> even without loop</p>
                </div>
                
                <h3>HALT Needs Check</h3>
                <p>4 binary toggles capture physiological state at intervention time:</p>
                <ul>
                    <li><strong>Hydration:</strong> Have you had water in the last 2 hours?</li>
                    <li><strong>Fuel:</strong> Have you eaten in the last 4 hours?</li>
                    <li><strong>Rest:</strong> Did you sleep 6+ hours last night?</li>
                    <li><strong>Movement:</strong> Have you moved your body today?</li>
                </ul>
                <p>Insight engine analyzes correlation: "Unmet hydration often appears before repeat high-risk stress loops"</p>
            </section>
            
            <!-- FAILURE MODES -->
            <section>
                <h2>‚ö†Ô∏è Failure Modes & Resilience</h2>
                
                <div class="warning-box">
                    <h4>Neo4j Unavailable</h4>
                    <ul>
                        <li><strong>Startup:</strong> Retry 5x with exponential backoff (2s, 4s, 8s, 16s, 30s)</li>
                        <li><strong>Runtime:</strong> All DB methods check <code>is_available</code> flag</li>
                        <li><strong>Degraded Mode:</strong> App continues with defaults (Low risk, no loops, empty history)</li>
                        <li><strong>Auto-recovery:</strong> Flag resets to true on next successful query</li>
                    </ul>
                </div>
                
                <div class="warning-box">
                    <h4>Ollama LLM Unavailable</h4>
                    <ul>
                        <li>Falls back to default: <code>detected_node = "Stress"</code>, <code>sublabel = "General"</code></li>
                        <li>User sees intervention but with generic emotion label</li>
                        <li>App remains functional</li>
                    </ul>
                </div>
                
                <div class="warning-box">
                    <h4>Frontend-Backend Disconnection</h4>
                    <ul>
                        <li>CORS configured with regex for dynamic localhost ports</li>
                        <li>Flutter shows error message, user can retry</li>
                        <li>No data loss (state not persisted until backend responds)</li>
                    </ul>
                </div>
            </section>
            
            <!-- TESTING -->
            <section>
                <h2>üß™ Testing Strategy</h2>
                
                <h3>Backend Tests (pytest)</h3>
                <ul>
                    <li><strong>tests/test_api.py:</strong> 10 endpoint tests with mocked DB & AI
                        <ul>
                            <li>test_analyze_endpoint</li>
                            <li>test_chronic_loop_detection</li>
                            <li>test_intervention_resets_loop</li>
                            <li>test_feedback_with_halt_results</li>
                            <li>test_insight_endpoint</li>
                            <li>test_history_endpoint</li>
                        </ul>
                    </li>
                    <li><strong>tests/test_rewire_smoke.py:</strong> 4 E2E validation tests
                        <ul>
                            <li>test_rewire_full_flow - Acute‚ÜíChronic‚ÜíHALT‚ÜíRecovery</li>
                            <li>test_sublabel_persistence_verification</li>
                            <li>test_intervention_type_contract</li>
                            <li>test_feature_flag_behavior</li>
                        </ul>
                    </li>
                </ul>
                
                <h3>Test Pattern: Dependency Injection Override</h3>
                <div class="info-box">
                    <p>Tests use <code>app.dependency_overrides[get_db] = lambda: _FakeDBManager()</code></p>
                    <p>This replaces real Neo4j driver with in-memory implementation that:</p>
                    <ul>
                        <li>Tracks state in Python lists/dicts</li>
                        <li>Simulates loop detection logic</li>
                        <li>Returns predictable results for assertions</li>
                        <li>No external dependencies (fast, isolated)</li>
                    </ul>
                </div>
            </section>
            
            <!-- DEPLOYMENT -->
            <section>
                <h2>üöÄ Deployment & Local Development</h2>
                
                <h3>Prerequisites</h3>
                <ul>
                    <li>Python 3.14+ with pip</li>
                    <li>Neo4j 5.x (via Docker or Homebrew)</li>
                    <li>Ollama with llama3.2:1b model</li>
                    <li>Flutter SDK 3.x</li>
                </ul>
                
                <h3>Launch Scripts</h3>
                <p><code>./launch_all.sh</code> - Starts all services in correct order:</p>
                <ol>
                    <li>Frees port 8000 (kills stale processes)</li>
                    <li>Starts Ollama (if not running)</li>
                    <li>Starts Neo4j via Homebrew</li>
                    <li>Activates Python venv and starts FastAPI backend</li>
                    <li>Launches Flutter web in Chrome</li>
                </ol>
                
                <h3>Configuration</h3>
                <p><strong>backend/.env:</strong></p>
                <code>
                    NEO4J_URI=bolt://localhost:7687<br>
                    NEO4J_USER=neo4j<br>
                    NEO4J_PASSWORD=yourpassword<br>
                    OLLAMA_MODEL=llama3.2:1b<br>
                    OLLAMA_URL=http://localhost:11434<br>
                    FEATURE_SUBLABELS=true<br>
                    FEATURE_NEEDS_CHECK=true<br>
                    FEATURE_RECOVERY_TREND=true<br>
                    FEATURE_MOVEMENT_PROTOCOLS=true
                </code>
            </section>
            
            <!-- ROADMAP -->
            <section>
                <h2>üó∫Ô∏è Future Roadmap</h2>
                
                <h3>P1 Backlog</h3>
                <ul>
                    <li><strong>LB-401:</strong> Expand movement protocol library with Zone 1-3 exercises</li>
                    <li><strong>LB-302:</strong> Null-safe parsing in history_screen.dart</li>
                    <li><strong>LB-503:</strong> Runbook documentation for deployment</li>
                </ul>
                
                <h3>P2 Enhancements</h3>
                <ul>
                    <li>Real-time insight push notifications</li>
                    <li>Weekly summary emails with pattern analysis</li>
                    <li>Therapist dashboard (multi-user support)</li>
                    <li>Export data to CSV/JSON</li>
                    <li>Integration with wearables (HRV tracking)</li>
                </ul>
            </section>
        </div>
    </div>
</body>
</html>
